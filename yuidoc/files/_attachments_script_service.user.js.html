<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>_attachments&#x2F;script&#x2F;service.user.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/$user
Couchdb user service.html">$user
Couchdb user service</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: _attachments&#x2F;script&#x2F;service.user.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;*
 Copyright 2013 Kevin Gaudin (kevin.gaudin@gmail.com)

 This file is part of Acralyzer.

 Acralyzer is free software: you can redistribute it and&#x2F;or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 Acralyzer is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with Acralyzer.  If not, see &lt;http:&#x2F;&#x2F;www.gnu.org&#x2F;licenses&#x2F;&gt;.
 *&#x2F;
(function(acralyzerConfig,acralyzer,acralyzerEvents,$) {
    &quot;use strict&quot;;
    &#x2F;**
    * @class $user
    * Couchdb user service
    * @extends ngService
    * @singleton
    *&#x2F;
    acralyzer.service(&#x27;$user&#x27;, [&#x27;$rootScope&#x27;, &#x27;$q&#x27;, function($rootScope, $q) {
        var ret = this;

        ret.hasAdminPath = undefined;
        &#x2F;**
        * Resets the user object back to the default state
        *&#x2F;
        ret.reset = function() {
            &#x2F;** 
             * @property {String} 
             * Username of current logged in user
             *&#x2F;
            ret.username = null;
            &#x2F;**
             * @property {Boolean}
             * Is current user an admin
             *&#x2F;
            ret.isAdmin = false;
            &#x2F;**
             * @property {Object}
             * Current users roles (as object)
             *&#x2F;
            ret.roles = {};
        };
        ret.reset();
        &#x2F;**
         * Updates the session of the current user 
         *
         * @private
         * @param {Promise} deferred Promise to update when completed
         *&#x2F;
        ret.updateSession = function(deferred) {
            $.couch.session({
                success : function(session) {
                    var userCtx = session.userCtx;
                    ret.roles = {};
                    userCtx.roles.forEach(function(role) {
                        ret.roles[role] = 1;
                    });
                    ret.isAdmin = (ret.roles[&#x27;_admin&#x27;] === 1);
                    ret.username = userCtx.name;
                    $rootScope.$broadcast(acralyzerEvents.LOGGED_IN, ret);
                    $rootScope.$broadcast(acralyzerEvents.LOGIN_CHANGE, ret);
                    if (ret.username &amp;&amp; ret.isAdmin &amp;&amp; ret.hasAdminPath === undefined )
                    {
                        $.ajax({
                            type: &quot;GET&quot;,
                            url: $.couch.urlPrefix + &quot;&#x2F;_config&#x2F;admins&#x2F;&quot; + ret.username,
                            beforeSend: function(xhr) {
                                xhr.setRequestHeader(&#x27;Accept&#x27;, &#x27;application&#x2F;json&#x27;);
                            },
                            complete: function(req) {
                                var resp = $.parseJSON(req.responseText);
                                if (req.status === 200 &amp;&amp; resp.match(&#x2F;^-hashed-&#x2F;)) {
                                    ret.hasAdminPath = true;
                                } else {
                                    ret.hasAdminPath = false;
                                }
                            }
                        });
                    }
                    if (deferred) {
                        deferred.resolve(ret);
                        $rootScope.$apply();
                    }
                },
                error: function(data) {
                    if (deferred) {
                        deferred.reject(data.reason);
                        $rootScope.$apply();
                    }
                }
            });
        };

        &#x2F;**
        * Logs in the user.
        *
        * @param {String} username Username to log in with
        * @param {String} password Password to log in username with
        *
        * @return {Promise} Promise for completion of login
        *&#x2F;

        ret.login = function(username, password) {
            var deferred = $q.defer();

            var options = {
                name: username,
                password: password,
                success: function(data) {
                    &#x2F;* Grab user session after login *&#x2F;
                    ret.updateSession(deferred);
                },
                error: function(data) {
                    deferred.reject(data.reason);
                    $rootScope.$apply();
                }
            };
            $.couch.login(options);

            return deferred.promise;
        };

        &#x2F;**
        * Changes the password of the currently logged in user
        *
        * Side effect: logs out user
        *
        * @param {String} password New Password for the user
        *
        * @return {Promise} Promise for completion of change password
        *&#x2F;
        ret.changePassword = function(password) {
            var deferred = $q.defer();
            if (!password) {
                deferred.reject(&quot;Missing password&quot;);
                return deferred.promise;
            }
            if (ret.isAdmin &amp;&amp; ret.hasAdminPath === true) {
                $.ajax({
                    type: &quot;PUT&quot;,
                    url: $.couch.urlPrefix + &quot;&#x2F;_config&#x2F;admins&#x2F;&quot; + ret.username,
                    data: &#x27;&quot;&#x27; + password + &#x27;&quot;&#x27;,
                    beforeSend: function(xhr) {
                        xhr.setRequestHeader(&#x27;Accept&#x27;, &#x27;application&#x2F;json&#x27;);
                    },
                    complete: function(req) {
                        var resp = $.parseJSON(req.responseText);
                        if (req.status === 200) {
                            &#x2F;* Once we update the password, our current session is expired *&#x2F;
                            &#x2F;* Tried re-logging in, but there&#x27;s a race condition here that is hard to track
                             * So easiest just to log the user out *&#x2F;
                            ret.logout().then(function() {
                                deferred.resolve();
                            });
                        } else {
                            deferred.reject(resp.reason);
                            $rootScope.$apply();
                        }
                    }
                });
                return deferred.promise;
            }
            $.couch.userDb(function(db) {
                var userDocId = &quot;org.couchdb.user:&quot;+ret.username;
                db.openDoc(userDocId, {
                    success : function(userDoc) {
                        userDoc.password = password;
                        db.saveDoc(userDoc, {
                            success : function() {
                                $rootScope.$broadcast(acralyzerEvents.USER_PASSWORD_CHANGE, ret);
                                $rootScope.$broadcast(acralyzerEvents.LOGIN_CHANGE, ret);
                                ret.logout().then(function() {
                                    deferred.resolve();
                                });
                            },
                            error: function(data) {
                                deferred.reject(data.missing);
                                $rootScope.$apply();
                            }
                        });
                    },
                    error: function() {
                        deferred.reject(ret);
                        $rootScope.$apply();
                    }
                });
            });
            return deferred.promise;
        };

        &#x2F;**
        * Logout the current user
        *
        * @return {Promise} Promise for completion of logout
        *&#x2F;
        ret.logout = function() {
            var deferred = $q.defer();

            $.couch.logout({
                success: function(data) {
                    ret.reset();
                    $rootScope.$broadcast(acralyzerEvents.LOGGED_OUT, ret);
                    $rootScope.$broadcast(acralyzerEvents.LOGIN_CHANGE, ret);
                    deferred.resolve(ret);
                    $rootScope.$apply();
                },
                error: function(data) {
                    deferred.resolve(ret);
                    $rootScope.$apply();
                }
            });
            return deferred.promise;
        };

        ret.updateSession();
        return ret;
    }]);

})(window.acralyzerConfig, window.acralyzer, window.acralyzerEvents, window.jQuery);

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
